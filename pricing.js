async function loadModels(){var r=await supabase.from('phone_models').select('*').eq('active',true).order('brand').order('display_name');if(r.error){toast(r.error.message);return;}var rp=await supabase.from('buyback_prices').select('*');if(rp.error){toast(rp.error.message);return;}var select=document.getElementById('modelSelect');select.innerHTML='';(r.data||[]).forEach(function(m){var opt=document.createElement('option');opt.value=m.model_id;opt.textContent=m.brand+' — '+m.display_name;select.appendChild(opt);});window.__models=r.data||[];window.__prices=Object.fromEntries((rp.data||[]).map(function(p){return [p.model_id,p];}));}function calcIntegrity(a){var s=0;switch(a.screen){case'perfect':s+=3;break;case'light':s+=2;break;case'heavy':s+=1;break;case'cracked':s+=0;break}switch(a.battery){case'great':s+=3;break;case'good':s+=2;break;case'ok':s+=1;break;case'poor':s+=0;break}switch(a.water){case'no':s+=3;break;case'maybe':s+=1;break;case'yes':s+=0;break}switch(a.lock){case'unlocked':s+=2;break;case'locked':s+=0;break}switch(a.storage){case'high':s+=2;break;case'mid':s+=1;break;case'low':s+=0;break}var i=1;if(s>=11)i=4;else if(s>=8)i=3;else if(s>=4)i=2;else i=1;return{integrity:i,score:s}}function qualityPriceFor(id,i){var r=window.__prices[id];if(!r)return 0;var map={1:'q1_price',2:'q2_price',3:'q3_price',4:'q4_price'};return Number(r[map[i]]||0)}document.addEventListener('DOMContentLoaded',async function(){await loadModels();var inputs=document.querySelectorAll('[data-q]');var last=null;document.getElementById('calcBtn').onclick=function(){var answers={};inputs.forEach(function(i){answers[i.dataset.q]=i.value});var res=calcIntegrity(answers);var model_id=document.getElementById('modelSelect').value;var price=qualityPriceFor(model_id,res.integrity);last={model_id:model_id,answers:answers,integrity:res.integrity,score:res.score,price:price};document.getElementById('integrityDisplay').textContent=res.integrity;document.getElementById('priceDisplay').textContent=price?'$'+price.toFixed(2):'—';document.getElementById('saveQuoteBtn').disabled=!price;};document.getElementById('saveQuoteBtn').onclick=async function(){if(!last)return;var ins=await supabase.from('quotes').insert([{model_id:last.model_id,quality:last.integrity,score:last.score,est_price:last.price,answers:last.answers}]);toast(ins.error?ins.error.message:'Quote saved.');};});