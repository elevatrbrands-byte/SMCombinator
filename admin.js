async function assertAdmin(){var u=await supabase.auth.getUser();var user=u.data?u.data.user:null;if(!user){toast('Please sign in first.');location.href='login.html';return false;}var r=await supabase.rpc('is_admin');if(r.error){toast(r.error.message);return false;}if(!r.data){toast('You are not an admin.');return false;}return true;}async function refresh(){var mT=document.getElementById('modelsTbody');var pT=document.getElementById('pricesTbody');var pM=document.getElementById('p-model');mT.innerHTML=pT.innerHTML=pM.innerHTML='';var m=await supabase.from('phone_models').select('*').order('brand').order('display_name');if(m.error){toast(m.error.message);return;}var pr=await supabase.from('buyback_prices').select('*');if(pr.error){toast(pr.error.message);return;}(m.data||[]).forEach(function(x){var tr=document.createElement('tr');tr.innerHTML='<td>'+x.display_name+'<br><span class="small">'+x.model_id+'</span></td><td>'+x.brand+'</td><td>'+(x.active?'Yes':'No')+'</td>';mT.appendChild(tr);var opt=document.createElement('option');opt.value=x.model_id;opt.textContent=x.display_name+' ('+x.model_id+')';pM.appendChild(opt);});(pr.data||[]).forEach(function(p){var tr=document.createElement('tr');tr.innerHTML='<td>'+p.model_id+'</td><td>$'+p.q1_price+'</td><td>$'+p.q2_price+'</td><td>$'+p.q3_price+'</td><td>$'+p.q4_price+'</td>';pT.appendChild(tr);});}document.addEventListener('DOMContentLoaded',async function(){if(!(await assertAdmin()))return;await refresh();document.getElementById('addModelBtn').onclick=async function(){var model={model_id:document.getElementById('m-id').value.trim(),display_name:document.getElementById('m-name').value.trim(),brand:document.getElementById('m-brand').value.trim()||'Generic',active:true};if(!model.model_id||!model.display_name){toast('Model id & name required.');return;}var up=await supabase.from('phone_models').upsert(model);toast(up.error?up.error.message:'Model saved.');await refresh();};document.getElementById('savePriceBtn').onclick=async function(){var id=document.getElementById('p-model').value;var row={model_id:id,q1_price:Number(document.getElementById('p-q1').value||0),q2_price:Number(document.getElementById('p-q2').value||0),q3_price:Number(document.getElementById('p-q3').value||0),q4_price:Number(document.getElementById('p-q4').value||0)};var up=await supabase.from('buyback_prices').upsert(row);toast(up.error?up.error.message:'Prices saved.');await refresh();};});